---
- name: Installer Dnsmasq et outils JSON
  ansible.builtin.package:
    name: 
      - dnsmasq
      - jq
    state: present

# On désactive systemd-resolved pour libérer le port 53 pour Dnsmasq
- name: Désactiver systemd-resolved (conflit port 53)
  ansible.builtin.service:
    name: systemd-resolved
    state: stopped
    enabled: no
  ignore_errors: yes

- name: Remplacer resolv.conf par localhost
  ansible.builtin.copy:
    dest: /etc/resolv.conf
    content: "nameserver 127.0.0.1"
    mode: '0644'

- name: Configurer Dnsmasq principal (Interfaces & Upstream)
  ansible.builtin.copy:
    dest: /etc/dnsmasq.conf
    content: |
      # Écouter sur l'interface physique (détectée par Ansible) et localhost
      interface={{ ansible_default_ipv4.interface }}
      interface=lo
      bind-interfaces
      
      # Options standard
      domain-needed
      bogus-priv
      no-resolv
      no-hosts
      expand-hosts
      
      # Serveurs DNS Upstream (Internet)
      server=1.1.1.1
      server=8.8.8.8
      
      # Inclure les configs dynamiques (Kubernetes)
      conf-dir=/etc/dnsmasq.d/,*.conf
  notify: Restart Dnsmasq

- name: Récupérer tous les services Kubernetes (JSON)
  ansible.builtin.command: k3s kubectl get services --all-namespaces -o json
  register: k8s_services_raw
  changed_when: false

- name: Extraire les IPs LoadBalancer MetalLB
  ansible.builtin.set_fact:
    lb_services: "{{ k8s_services_raw.stdout | from_json | json_query(query) }}"
  vars:
    query: "items[?spec.type=='LoadBalancer' && status.loadBalancer.ingress[0].ip].{name: metadata.name, namespace: metadata.namespace, ip: status.loadBalancer.ingress[0].ip}"

- name: Identifier l'IP de Traefik (Ingress Controller)
  ansible.builtin.set_fact:
    traefik_lb: "{{ lb_services | selectattr('name', 'search', 'traefik') | first | default(None) }}"

- name: Configurer Dnsmasq (Zones Kubernetes)
  ansible.builtin.template:
    src: dnsmasq-k8s.conf.j2
    dest: /etc/dnsmasq.d/99-k8s-dynamic.conf
    mode: '0644'
  notify: Restart Dnsmasq

- name: "UFW: Autoriser DNS UDP depuis le réseau local (et VPN via NAT)"
  community.general.ufw:
    rule: allow
    port: '53'
    proto: udp
    from_ip: "{{ ansible_default_ipv4.network }}/{{ ansible_default_ipv4.netmask }}"
    comment: "DNS Access from LAN and VPN"

- name: "UFW: Autoriser DNS TCP"
  community.general.ufw:
    rule: allow
    port: '53'
    proto: tcp
    from_ip: "{{ ansible_default_ipv4.network }}/{{ ansible_default_ipv4.netmask }}"
    comment: "DNS Access from LAN and VPN"

- name: Démarrer Dnsmasq
  ansible.builtin.service:
    name: dnsmasq
    state: started
    enabled: yes