---
- name: V√©rifier que kubectl est disponible
  ansible.builtin.command: k3s kubectl version --client
  changed_when: false
  register: kubectl_check

- name: Cr√©er le namespace Cert-Manager
  ansible.builtin.command: k3s kubectl create namespace {{ cert_manager_namespace }}
  register: cm_ns_create
  changed_when: "'created' in cm_ns_create.stdout"
  failed_when:
    - cm_ns_create.rc != 0
    - "'AlreadyExists' not in cm_ns_create.stderr"

- name: T√©l√©charger le manifest Cert-Manager
  ansible.builtin.get_url:
    url: "{{ cert_manager_manifest_url }}"
    dest: "/tmp/cert-manager.yaml"
    mode: '0644'

- name: Appliquer le manifest Cert-Manager
  ansible.builtin.command: k3s kubectl apply -f /tmp/cert-manager.yaml
  register: cm_apply
  changed_when: "'created' in cm_apply.stdout or 'configured' in cm_apply.stdout"

- name: Attendre que les pods Cert-Manager soient pr√™ts
  ansible.builtin.command: |
    k3s kubectl wait --namespace {{ cert_manager_namespace }} \
      --for=condition=ready pod \
      --selector=app.kubernetes.io/instance=cert-manager \
      --timeout={{ cert_manager_wait_timeout }}s
  register: cm_wait
  changed_when: false
  retries: 5
  delay: 10
  until: cm_wait.rc == 0

- name: Pause pour la propagation du Webhook (Crucial)
  ansible.builtin.pause:
    seconds: 30
    prompt: "Attente de la disponibilit√© de l'API Webhook..."

- name: Cr√©er le fichier de configuration PKI
  ansible.builtin.template:
    src: pki_issuer.yaml.j2
    dest: /tmp/pki_issuer.yaml
    mode: '0644'

- name: Appliquer la configuration PKI (Root CA & Issuer)
  ansible.builtin.command: k3s kubectl apply -f /tmp/pki_issuer.yaml
  register: pki_apply
  changed_when: "'created' in pki_apply.stdout or 'configured' in pki_apply.stdout"

- name: Attendre que le certificat Racine soit pr√™t
  ansible.builtin.command: |
    k3s kubectl wait --namespace {{ cert_manager_namespace }} \
      --for=condition=ready certificate my-root-ca \
      --timeout=60s
  register: ca_wait
  changed_when: false

- name: R√©cup√©rer le certificat public (ca.crt)
  ansible.builtin.shell: |
    k3s kubectl get secret root-ca-secret -n {{ cert_manager_namespace }} -o jsonpath='{.data.ca\.crt}' | base64 -d
  register: root_ca_cert
  changed_when: false

- name: Sauvegarder le certificat racine sur le noeud
  ansible.builtin.copy:
    content: "{{ root_ca_cert.stdout }}"
    dest: "/root/root-ca.crt"
    mode: '0644'

- name: R√©cup√©rer le certificat racine en local (sur votre PC)
  ansible.builtin.fetch:
    src: "/root/root-ca.crt"
    dest: "../certs/cluster-root-ca.crt"
    flat: yes

- name: Message de confirmation
  ansible.builtin.debug:
    msg: 
      - "‚úÖ PKI d√©ploy√©e avec succ√®s !"
      - "üìù Issuer √† utiliser : 'local-pki-issuer'"
      - "üîë Le certificat racine est dans ./certs/cluster-root-ca.crt"
      - "‚ÑπÔ∏è  Importez ce fichier dans votre navigateur (Autorit√©s) pour avoir le cadenas vert."