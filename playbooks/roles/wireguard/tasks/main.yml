---
- name: Installer WireGuard et UFW
  become: yes
  ansible.builtin.apt:
    name:
      - wireguard
      - iptables
      - ufw
    state: present
    update_cache: yes

- name: Cr√©er le dossier de cl√©s
  become: yes
  file:
    path: "{{ server_keys_dir }}"
    state: directory
    mode: '0700'
    owner: root
    group: root

- name: G√©n√©rer et lire les cl√©s (Bloc condens√©)
  become: yes
  block:
    - shell: "wg genkey | tee {{ server_keys_dir }}/server_private.key | wg pubkey > {{ server_keys_dir }}/server_public.key"
      args:
        creates: "{{ server_keys_dir }}/server_private.key"
    - slurp:
        src: "{{ server_keys_dir }}/{{ item }}"
      loop: [server_private.key, server_public.key]
      register: server_keys

- name: G√©n√©rer et lire les cl√©s Clients
  become: yes
  block:
    - shell: "wg genkey | tee {{ server_keys_dir }}/{{ item.name }}_private.key | wg pubkey > {{ server_keys_dir }}/{{ item.name }}_public.key"
      args:
        creates: "{{ server_keys_dir }}/{{ item.name }}_private.key"
      loop: "{{ wg_clients }}"
    - slurp:
        src: "{{ server_keys_dir }}/{{ item.name }}_public.key"
      loop: "{{ wg_clients }}"
      register: client_pub_files
    - slurp:
        src: "{{ server_keys_dir }}/{{ item.name }}_private.key"
      loop: "{{ wg_clients }}"
      register: client_priv_files

- name: Activer IP Forwarding
  become: yes
  ansible.posix.sysctl:
    name: net.ipv4.ip_forward
    value: '1'
    sysctl_set: yes
    state: present
    reload: yes

- name: Configurer UFW Forward Policy √† ACCEPT
  become: yes
  ansible.builtin.lineinfile:
    path: /etc/default/ufw
    regexp: '^DEFAULT_FORWARD_POLICY='
    line: 'DEFAULT_FORWARD_POLICY="ACCEPT"'
  notify: Reload UFW

- name: Configurer le DOUBLE NAT dans UFW (before.rules)
  become: yes
  ansible.builtin.blockinfile:
    path: /etc/ufw/before.rules
    marker: "# {mark} ANSIBLE MANAGED BLOCK - NAT WIREGUARD"
    insertbefore: BOF
    block: |
      *nat
      :POSTROUTING ACCEPT [0:0]
      -A POSTROUTING -s {{ vpn_subnet }} -o {{ wan_interface }} -j MASQUERADE
      -A POSTROUTING -s {{ vpn_subnet }} -o {{ vm_bridge_interface }} -j MASQUERADE
      COMMIT
  notify: Reload UFW

- name: Ouvrir les ports SSH et WireGuard
  become: yes
  community.general.ufw:
    rule: allow
    port: "{{ item.port }}"
    proto: "{{ item.proto }}"
    comment: "{{ item.comment }}"
  loop:
    - { port: '22', proto: 'tcp', comment: 'SSH Access' }
    - { port: "{{ wireguard_port }}", proto: 'udp', comment: 'WireGuard VPN' }

- name: Cr√©er le script de persistance UFW (after.init)
  become: yes
  copy:
    dest: /etc/ufw/after.init
    mode: '0755'
    content: |
      #!/bin/sh
      # Script g√©n√©r√© par Ansible pour WireGuard
      # Force l'insertion des r√®gles FORWARD en 1√®re position pour passer avant Libvirt
      
      # 1. VPN vers VMs
      iptables -I FORWARD 1 -i wg0 -o {{ vm_bridge_interface }} -j ACCEPT
      
      # 2. VMs vers VPN
      iptables -I FORWARD 1 -i {{ vm_bridge_interface }} -o wg0 -j ACCEPT
      
      # 3. Log (Optionnel, pour debug)
      # logger "UFW after.init: WireGuard/Libvirt rules inserted"
      
      exit 0
  notify: Reload UFW

- name: G√©n√©rer les fichiers .conf Clients
  become: yes
  template:
    src: templates/wg-client.conf.j2
    dest: "{{ server_keys_dir }}/{{ item.0.name }}.conf"
    mode: '0600'
  vars:
    client: "{{ item.0 }}"
    client_private_key: "{{ item.1['content'] | b64decode | trim }}"
    server_public_key: "{{ server_keys.results[1]['content'] | b64decode | trim }}"
  loop: "{{ wg_clients | zip(client_priv_files.results) | list }}"

- name: D√©ployer la configuration Serveur
  become: yes
  template:
    src: templates/wg-server.conf.j2
    dest: "/etc/wireguard/{{ wg_interface }}.conf"
    mode: '0600'
  vars:
    server_private_key: "{{ server_keys.results[0]['content'] | b64decode | trim }}"
    peers: "{{ wg_clients | zip(client_pub_files.results) | list }}"
  notify: Restart WireGuard

- name: D√©marrer le service WireGuard
  become: yes
  systemd:
    name: "wg-quick@{{ wg_interface }}"
    state: started
    enabled: yes

- name: Lire et afficher les configs
  become: yes
  ansible.builtin.slurp:
    src: "{{ server_keys_dir }}/{{ item.name }}.conf"
  register: all_client_confs
  loop: "{{ wg_clients }}"

- name: üü¢ AFFICHER LES CLIENTS üü¢
  ansible.builtin.debug:
    msg: "{{ (item.content | b64decode).split('\n') }}"
  loop: "{{ all_client_confs.results }}"
  loop_control:
    label: "{{ item.item.name }}"