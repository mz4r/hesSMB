# - name: Install Kubernetes Cluster (Single Node)
#   hosts: vms
#   become: yes
#   roles:
#     - ./roles/DEBIAN12-CIS

- name: task pour patch a modifier dans le hardening pour fonctionnement final
  hosts: all
  gather_facts: yes
  become: true
  tasks:
    - name: üåç Configuration du DNS (resolv.conf)
      copy:
        dest: /etc/resolv.conf
        content: |
          nameserver 1.1.1.1
        mode: '0644'

    - name: D√©sactiver le swap imm√©diatement
      ansible.builtin.command: swapoff -a
      changed_when: false
      failed_when: false

    - name: D√©sactiver le swap de mani√®re permanente (commentaire dans /etc/fstab)
      ansible.builtin.replace:
        path: /etc/fstab
        regexp: '^([^#].*?\sswap\s+sw\s+.*)$'
        replace: '# \1'
      register: fstab_swap

    - name: Reset complet de UFW
      community.general.ufw:
        state: reset
    - name: Appliquer les r√®gles UFW
      community.general.ufw:
        rule: allow
        port: "{{ item.port | default(omit) }}"
        proto: "{{ item.proto | default('any') }}"
        src: "{{ item.src | default('any') }}"
        comment: "{{ item.comment }}"
      loop:
        - { port: '51821', proto: 'udp', comment: 'WireGuard Listen Port' }
        - { port: '22', proto: 'tcp', comment: 'SSH Access' }

    - name: D√©finir le hostname du syst√®me
      ansible.builtin.hostname:
        name: "{{ inventory_hostname }}"

    - name: Ajouter le hostname dans /etc/hosts (Pour √©viter l'erreur 'unable to resolve host')
      ansible.builtin.lineinfile:
        path: /etc/hosts
        regexp: '^127\.0\.0\.1'
        line: "127.0.0.1 {{ inventory_hostname }} localhost"
        state: present



- name: task pour patch a modifier dans le hardening pour fonctionnement final
  gather_facts: yes
  become: true
  hosts: vms
  tasks:
    - name: "FIX DISK: Installer les outils n√©cessaires (parted & growpart)"
      become: yes
      ansible.builtin.package:
        name:
          - parted
          - cloud-guest-utils
        state: present
        update_cache: yes

    - name: "FIX DISK: V√©rifier les partitions existantes"
      become: yes
      shell: "lsblk -ln -o NAME /dev/vda"
      register: disk_partitions
      changed_when: false

    - name: "FIX DISK: D√©sactiver le SWAP (si pr√©sent)"
      become: yes
      command: swapoff -a
      when: "'vda5' in disk_partitions.stdout"
      ignore_errors: yes

    - name: "FIX DISK: Supprimer la partition logique vda5 (si elle existe)"
      become: yes
      command: parted /dev/vda rm 5
      when: "'vda5' in disk_partitions.stdout"

    - name: "FIX DISK: Supprimer la partition √©tendue vda2 (si elle existe)"
      become: yes
      command: parted /dev/vda rm 2
      when: "'vda2' in disk_partitions.stdout"

    - name: "FIX DISK: Agrandir la partition racine (vda1)"
      become: yes
      command: "growpart /dev/vda 1"
      register: grow_root
      failed_when: grow_root.rc != 0 and grow_root.rc != 1
      changed_when: grow_root.rc == 0

    - name: "FIX DISK: √âtendre le syst√®me de fichiers (ext4)"
      become: yes
      command: "resize2fs /dev/vda1"
      when: grow_root.rc == 0 or grow_root.rc == 1
      register: resize_fs
      changed_when: "'The filesystem on' in resize_fs.stdout"

    - name: Confirmation
      debug:
        msg: "Op√©ration termin√©e. Disque √©tendu."