- name: Install Kubernetes Cluster (Single Node)
  hosts: all
  become: yes
  roles:
    - ./roles/DEBIAN12-CIS

- name: task pour patch a modifier dans le hardening pour fonctionnement final
  hosts: all
  gather_facts: yes
  become: true
  tasks:
    - name: üåç Configuration du DNS (resolv.conf)
      copy:
        dest: /etc/resolv.conf
        content: |
          nameserver 1.1.1.1
        mode: '0644'

    - name: D√©sactiver le swap imm√©diatement
      ansible.builtin.command: swapoff -a
      changed_when: false
      failed_when: false

    - name: D√©sactiver le swap de mani√®re permanente (commentaire dans /etc/fstab)
      ansible.builtin.replace:
        path: /etc/fstab
        regexp: '^([^#].*?\sswap\s+sw\s+.*)$'
        replace: '# \1'
      register: fstab_swap

    - name: Reset complet de UFW
      community.general.ufw:
        state: reset
    - name: Appliquer les r√®gles UFW
      community.general.ufw:
        rule: allow
        port: "{{ item.port | default(omit) }}"
        proto: "{{ item.proto | default('any') }}"
        src: "{{ item.src | default('any') }}"
        comment: "{{ item.comment }}"
      loop:
        - { port: '51821', proto: 'udp', comment: 'WireGuard Listen Port' }
        - { port: '22', proto: 'tcp', comment: 'SSH Access' }

    - name: D√©finir le hostname du syst√®me
      ansible.builtin.hostname:
        name: "{{ inventory_hostname }}"

    - name: Ajouter le hostname dans /etc/hosts (Pour √©viter l'erreur 'unable to resolve host')
      ansible.builtin.lineinfile:
        path: /etc/hosts
        regexp: '^127\.0\.0\.1'
        line: "127.0.0.1 {{ inventory_hostname }} localhost"
        state: present
